# App
APP_NAME=Sanal Mülakatım
SUPPORT_EMAIL=semi.ozgen@sanalmulakatim.com

# OpenAI
OPENAI_API_KEY=
OPENAI_MODEL=gpt-4o-mini
OPENAI_TRANSCRIBE_MODEL=gpt-4o-mini-transcribe
OPENAI_OCR_MODEL=gpt-4o-mini
OPENAI_TIMEOUT=90
OPENAI_JSON_MAX_TOKENS=2500

# PDF / OCR limits
MAX_PDF_MB=8
PDF_MAX_PAGES=6
OCR_MAX_PAGES=2
OCR_ZOOM=2.0

# Usage limits (Free plan)
# Ücretsiz deneme (değerlendirme) hakkı (TOPLAM)
FREE_EVALS_TOTAL=3

# Ses → yazı FREE'de dahil (ayrı kota yok). İstersen yine de rate limit kullan.
FREE_TRANSCRIBES_PER_DAY=0

# OCR pahalı bir işlem olduğu için (şimdilik) günlük limit.
FREE_OCR_PER_DAY=2

# Rate limiting (per client)
# Eski degisken: default fallback olarak kullanilir
RATE_LIMIT_PER_MINUTE=60

# Endpoint-bazli rate limit (opsiyonel overrides)
# default: RATE_LIMIT_DEFAULT_PER_MIN veya RATE_LIMIT_PER_MINUTE
RATE_LIMIT_DEFAULT_PER_MIN=60
RATE_LIMIT_DEFAULT_WINDOW_SEC=60

# Ornek per-key overrides
# RATE_LIMIT_EVAL_PER_MIN=20
# RATE_LIMIT_BILLING_PER_MIN=6
# RATE_LIMIT_TRANSCRIBE_PER_MIN=10
# RATE_LIMIT_PARSE_PDF_PER_MIN=4
# Pro icin ayri
# RATE_LIMIT_EVAL_PER_MIN_PRO=200
# RATE_LIMIT_BILLING_PER_MIN_PRO=60

# Pro rate limit bypass (1=evet, 0=hayir)
PRO_BYPASS_RATE_LIMIT=1

# Pro access (manual)
# Comma-separated tokens. If request includes header X-Pro-Token matching one of these, limits are lifted.
PRO_TOKENS=

# Payments (optional)
# PAYMENT_PROVIDER=stripe|iyzico
PAYMENT_PROVIDER=iyzico
PUBLIC_BASE_URL=http://localhost:5555

# Pro pricing (used by iyzico)
PRO_PRICE_TRY=199.0
PRO_TITLE=Pro Erişim

# Stripe (optional)
STRIPE_SECRET_KEY=
STRIPE_PRICE_ID=
STRIPE_WEBHOOK_SECRET=

# iyzico (optional - Checkout Form / Hosted Payment Page)
IYZICO_API_KEY=
IYZICO_SECRET_KEY=
IYZICO_BASE_URL=https://sandbox-api.iyzipay.com
IYZICO_TIMEOUT=25

# Optional default buyer fields (production'da gerçek kullanıcı bilgilerini toplaman gerekebilir)
IYZICO_BUYER_NAME=Kullanıcı
IYZICO_BUYER_SURNAME=-
IYZICO_IDENTITY_NUMBER=11111111111
IYZICO_GSM_NUMBER=+905350000000
IYZICO_FALLBACK_EMAIL=user@example.com
IYZICO_ADDRESS=Adres bilgisi
IYZICO_CITY=Istanbul
IYZICO_COUNTRY=Turkey
IYZICO_ZIP=34000

# Sentry (optional error tracking)
SENTRY_DSN=
LOG_LEVEL=INFO



# Auto email (optional)
# Ödeme başarılı olunca Pro anahtarını otomatik e-posta at.
AUTO_EMAIL_TOKEN_ON_PAYMENT=1

# SMTP (optional - Pro anahtarını e-posta ile göndermek için)
# Örn: Gmail için "App Password" gerekir.
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
SMTP_FROM=
SMTP_FROM_NAME=Sanal Mülakatım
SMTP_USE_TLS=1
SMTP_USE_SSL=0

# Privacy / Retention
DATA_RETENTION_DAYS=90

# ---------------------------------------------------------------------------
# Database
# ---------------------------------------------------------------------------
# Default: SQLite (single instance).
# For blue/green + multi-instance prod: use Postgres.
DB_ENGINE=sqlite

# Option A (recommended): full URL
DATABASE_URL=

# Option B: build URL from parts (works when DB_ENGINE=postgres)
PG_HOST=postgres
PG_PORT=5432
PG_DB=sanal_mulakatim
PG_USER=sanal
PG_PASSWORD=

# Pro recovery (magic link)
# Not storing raw e-mail; we hash with salt. Change these in production.
EMAIL_HASH_SALT=change-me
RECOVERY_TOKEN_SECRET=change-me-too
RECOVERY_TOKEN_TTL_MIN=15

# --- Security / Launch ---
CLIENT_ID_SALT=change-me
ALLOWED_HOSTS=localhost,127.0.0.1
ALLOWED_ORIGINS=http://localhost:5555,http://127.0.0.1:5555
TRUST_PROXY_HEADERS=0
REQUIRE_ORIGIN=1
SECURITY_HEADERS=1
HSTS=0
ENABLE_API_DOCS=1
ADMIN_STATUS_KEY=
ADMIN_2FA_KEY=
# Reverse proxy -> backend shared secret header for /admin/* and /api/admin/* (defence-in-depth)
ADMIN_EDGE_TOKEN=
# Extra defence: optional IP allowlist for /admin/security and /api/admin/security/*
# (Still recommended to put these behind Caddy Basic Auth + IP allowlist.)
ADMIN_PANEL_ALLOW_IPS=   # e.g. "1.2.3.4 5.6.7.0/24"
MAX_PDF_PAGES=10

# WAF / ban list (basic bot protection)
WAF_ENABLED=1
WAF_BLOCK=1
WAF_MAX_BODY_BYTES=4096
WAF_MAX_QUERY_LEN=2048

BAN_ENABLED=1
BAN_WINDOW_SEC=300
BAN_THRESHOLD=40
BAN_TTL_SEC=3600
BAN_STRIKE_STATUSES=401,403,429


# ---------------------------------------------------------------------------
# Endpoint-bazli rate limit (opsiyonel)
# ---------------------------------------------------------------------------
# Eski RATE_LIMIT_PER_MINUTE degiskeni 'default' olarak kullanilir.
# Pro icin tamamen bypass etmek istersen:
PRO_BYPASS_RATE_LIMIT=1

# Default (tum key'ler icin fallback)
RATE_LIMIT_DEFAULT_PER_MIN=60
RATE_LIMIT_DEFAULT_WINDOW_SEC=60

# Key bazli ornekler (opsiyonel)
# RATE_LIMIT_EVAL_PER_MIN=20
# RATE_LIMIT_BILLING_PER_MIN=6
# RATE_LIMIT_TRANSCRIBE_PER_MIN=10
# RATE_LIMIT_PARSE_PDF_PER_MIN=6

# Pro icin (opsiyonel)
# RATE_LIMIT_EVAL_PER_MIN_PRO=200
# RATE_LIMIT_BILLING_PER_MIN_PRO=60

# ---------------------------------------------------------------------------
# Strike weight (ban sistemi)
# ---------------------------------------------------------------------------
BAN_STRIKE_WEIGHT_WAF=5
BAN_STRIKE_WEIGHT_429=2

# CAPTCHA (Cloudflare Turnstile) - protects email-triggering endpoints
# Supported provider: turnstile
CAPTCHA_PROVIDER=    # empty = disabled
TURNSTILE_SITE_KEY=
TURNSTILE_SECRET_KEY=
# If Turnstile verification is temporarily unreachable: 1 = allow (less secure), 0 = block (more secure)
CAPTCHA_FAIL_OPEN=0
# Apply CAPTCHA to email-triggering endpoints (recovery + delete)
CAPTCHA_REQUIRED_EMAIL=1
CAPTCHA_TIMEOUT=5.0
BAN_STRIKE_WEIGHT_CAPTCHA=5

# Privacy delete confirmation token TTL (minutes)
PRIVACY_DELETE_TOKEN_TTL_MIN=30

# Debug only: return privacy-delete token in API response (NEVER enable in production)
DEBUG_RETURN_PRIVACY_DELETE_TOKEN=0

# Optional in-app extra defense for /admin/security (in addition to Caddy)
# Space-separated IPs/CIDRs, e.g.: "1.2.3.4 5.6.7.0/24"
ADMIN_PANEL_ALLOW_IPS=
BAN_STRIKE_WEIGHT_DEFAULT=1

# Security events retention (admin panel)
SECURITY_EVENT_RETENTION_DAYS=30


# Progressive delay for suspicious clients (pre-ban throttle)
BAN_SOFT_DELAY_MS_MAX=600

# ---------------------------------------------------------------------------
# Automatic Lockdown (attack spike response)
# ---------------------------------------------------------------------------
# When security events spike, temporarily block expensive endpoints to keep the service alive.
LOCKDOWN_ENABLED=1
LOCKDOWN_WINDOW_SEC=60
LOCKDOWN_THRESHOLD_EVENTS=120
LOCKDOWN_THRESHOLD_SOURCES=30
LOCKDOWN_TTL_SEC=300
LOCKDOWN_CHECK_EVERY_SEC=5
# Which security events contribute to spike detection
LOCKDOWN_EVENT_TYPES=waf_trigger,ban_applied,rate_limit,captcha_fail,payload_too_large
# Which endpoints are blocked during lockdown (comma-separated prefixes)
LOCKDOWN_BLOCK_PREFIXES=/api/evaluate,/api/start,/api/next,/api/transcribe,/api/parse_pdf,/api/billing/create_checkout,/api/billing/email_token,/api/pro/recovery,/api/privacy/delete


# ---------------------------------------------------------------------------
# Session hardening (DoS / cost protection)
# ---------------------------------------------------------------------------
# Session TTL (hours). Old sessions are cleaned up automatically.
SESSION_TTL_HOURS=24
# Hard cap on number of sessions stored in memory (defence-in-depth).
MAX_SESSIONS_TOTAL=2000
# Per-client active session cap (prevents bots from spamming /api/start).
MAX_ACTIVE_SESSIONS_PER_CLIENT=3

# ---------------------------------------------------------------------------
# In-flight concurrency limits (defence-in-depth)
# ---------------------------------------------------------------------------
# Limits parallel expensive work per client and globally.
# Set 0 to disable a cap.
PRO_BYPASS_INFLIGHT=1
INFLIGHT_TTL_SEC=3600

# Global caps
START_MAX_INFLIGHT_GLOBAL=6
EVAL_MAX_INFLIGHT_GLOBAL=6
NEXT_MAX_INFLIGHT_GLOBAL=6
TRANSCRIBE_MAX_INFLIGHT_GLOBAL=3
PARSE_PDF_MAX_INFLIGHT_GLOBAL=2
OCR_MAX_INFLIGHT_GLOBAL=2

# Per-client caps
START_MAX_INFLIGHT_PER_CLIENT=1
EVAL_MAX_INFLIGHT_PER_CLIENT=1
NEXT_MAX_INFLIGHT_PER_CLIENT=1
TRANSCRIBE_MAX_INFLIGHT_PER_CLIENT=1
PARSE_PDF_MAX_INFLIGHT_PER_CLIENT=1
OCR_MAX_INFLIGHT_PER_CLIENT=1

# ---------------------------------------------------------------------------
# Safer defaults
# ---------------------------------------------------------------------------
# Tokens in URL query can leak via proxy/server logs. Keep disabled in production.
ALLOW_TOKEN_IN_URL=0
